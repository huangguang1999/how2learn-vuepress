## JavaScript数组内存模型

JavaScript 的内存分为堆内存和栈内存，数组作为对象，在建立后存储在堆内存中。

内存的分配经历三个阶段：

1. 分配内存
2. 对内存进行读/写
3. 释放内存



JavaScript中数组特点：

* **数组中可以存放不同的数据结构**
* **数组的 index 是字符串类型的**



数组本来应该是一个**连续的内存分配**，但是在 JavaScript 中不是连续分配的，而是类似哈希映射或字典的方式存在的。



### 为什么JavaScript数组不是实际数组

正常来说数组是一堆**连续**的内存位置，用于保存一些值。

![数组内存表示](https://gitee.com/huangguang1999/blog-image/raw/master/img/actual-array-js_phm7td.png)

上面图片中中展示了数组的内存形式，这样就可以容纳4个4 bits 的元素，这样就占用了16位存储块，所有存储块的顺序相同。

假设我已经声明 `Int arr[4]`，并且它已经创建了一系列从1201内存块开始的地址，现在如果尝试读取 `a[2]`，CPU 可以直接计算 1201 + (2 * 4) 的内存地址去获取。



![img](https://gitee.com/huangguang1999/blog-image/raw/master/img/old-array-js_o8ufwz.png)

但是在 JavaScript 中，数组是哈希映射，可以使用各种数据结构来实现它，例如链表。因此在JavaScript中如果声明一个数组将会形成上图所示的结构。如果想从 `a[2]` 的位置读取必须要从1201开始遍历查找。



### JavaScript数组的演变

所以浏览器为了优化其操作，对数组创建的时候内存分配进行了优化：

* 对于同构的数组，也就是说数组中元素类型一致，会创建连续的内存分配
* 对于不同构数组，按照原来的方式创建
* 如果你想插入一个异构数据，那么就会重新结构，通过哈希映射的方式创建



### 优化

我们可以采用两种方法优化：



**正确编写代码**

只要正确的去编写优质代码，尽量使数组是同构数组，这样代码的执行速率就会快一点。



[**类型化数组ArrayBuffer**](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Typed_arrays)

JavaScript类型化数组是一种类似数组的对象，并提供了一种用于访问原始二进制数据的机制。 正如你可能已经知道，`Array`存储的对象能动态增多和减少，并且可以存储任何JavaScript值。JavaScript引擎会做一些内部优化，以便对数组的操作可以很快。然而，随着Web应用程序变得越来越强大，尤其一些新增加的功能例如：音频视频编辑，访问WebSockets的原始数据等，很明显有些时候如果使用JavaScript代码可以快速方便地通过类型化数组来操作原始的二进制数据将会非常有帮助。





## JavaScript对象内存模型



## JavaScript函数内存模型

